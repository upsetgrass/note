# 介绍

该文件对RISC-V高级中断架构进行了规定：
对《RISC-V指令集手册》第二卷规定的标准RISC-V hart（核心）特权架构进行了扩展，使得在现有的特权层级上支持更灵活的中断机制

ps：hart（Hardware Thread） - 硬件线程，表示一个可以独立执行指令流的处理单元，每个hart可以视为一个独立的CPU核心或线程，可以执行自己的指令、管理自己的寄存器，独立的处理中断和进行上下文切换（单核处理器一般只有一个hart）

AIA中定义了两个标准中断控制器，用于不同规模和需求的RISC-V系统 1）高级平台级中断控制器（APLIC）：用于更大或更复杂的系统，可以处理更复杂的中断需求    2）信息信号型中断控制器（IMSIC）：用于接收和处理信息信号中断（MSI）的控制器，适合分布式或虚拟化的系统架构。

AIA对与中断相关的其他系统组件提出了要求，以确保整个系统能有效的处理中断。包括如何管理中断信号、如何支持**虚拟化中断**。

## 具体组成

RISC-V系统中，系统架构中断信号的设计与采用的中断类型，即信息传递中断（MSI，Message-Signaled Interrupts）还是传统的有线中断（wired interrupts）

**支持消息传递中断的系统**：对于完全支持MSI的系统中，每个处理核心（hart）都会配备一个**入站 MSI 控制器（IMSIC，Incoming MSI Controller）**，用来作为该核心的专用中断控制器，专门处理来自外部的中断信号。IMSIC 让每个核心可以直接接收 MSI 中断请求，适用于较大的系统，特别是那些带有 PCI 设备的系统，通过提供核心IMSICs（多个核心的中断控制器），有望完全支持MSIs（多个信息传递中断），对于较小的系统，继续使用有线中断和没有IMSICs的简单核心。

ps：PCI - 用于连接计算机主板和各种外设设备（显卡、网卡和存储设备）的高速接口标准，是一种标准化、快速的数据传输方式。

ps：IMSICs - 是为了多核处理器设计的，以便每个hart可以独立处理中断信号，提高并行处理能力和系统响应效率。

ps：外部中断 - 指的是有处理器以外的硬件设备产生的中断信号，对于软件发出的中断信号属于软件中断/内部中断，比如操作系统的系统调用等，软件中断不需要APLIC或者IMSIC，定时器中断是内部中断。

**基于传统有线中断的系统**：在这种系统中，核心没有 IMSIC 控制器。系统中断信号通过有线连接方式传递。通常，小型系统的设计更适合这种方法，因为它简化了硬件设计，适合不需要 MSI 支持的简单核心。



### 没有IMSICs的外部中断

当RISC-V的核心没有IMSIC，外部中断通过专用线路发送给核心（hart），核心中的APLIC充当传统的**中心化中断控制器**，用于路由和优先级排序来自不同外部设备的中断信号，将中断信号路由到每个处理核心的适当级别（M级、S级、U级）

在没有IMSIC的情况下，就算RISC-V实现了**特权架构**中的hypervisor extension（**虚拟机监控器扩展**），当前的AIA也不支持外部中断直接传递给**虚拟机**，需要通过hypervisor（**虚拟机监控器**），由虚拟机监控器选择是否将中断转换为虚拟中断，并将其注入到虚拟机中。

ps：虚拟机监控器（Hypervisor）运行在物理硬件或操作系统上的软件层，负责创建和管理虚拟机。

ps：虚拟机监控器扩展（hypervisor extension）是RISC-V特权架构中引入的一种扩展，旨在支持虚拟化，允许一个虚拟机监控器能够管理多个虚拟机

ps：虚拟机（Virtual Machine，VM）虚拟机是由虚拟监控器创建的一个逻辑计算环境，可以运行自己的操作系统和应用程序



下图是有线中断的流程，有线中断发送中断信号给APLIC，APLIC负责中断挂起和中断使能，来记录当前待处理和中断是否被允许触发，允许触发后将中断信号按照优先级、路由选择等方式选择M还是S级的中断发送给核心。

![image-20241115155048502](https://raw.githubusercontent.com/upsetgrass/typora_pic_bed/main/image-20241115155048502.png)

### 有IMSICs的外部中断

为了能够接收 MSI 信号，每个 RISC-V 核心需要配备一个 IMSIC。IMSIC 是 RISC-V hart 的专用组件，在系统的物理地址空间中被分配了一个唯一标识地址。IMSIC 的多个功能内存地址是基于这个唯一标识地址通过偏移计算得到的，分布在一定的地址范围内。当系统对这些地址之一进行符合预期格式的写操作时，IMSIC 会将其解析为该 hart 的外部中断请求。

对于能够接收MSI信号的RISC-V系统，系统中任然会包含一个APLIC，但是其作用是将有线中断转换为MSI write，并通过特定的IMSIC将信息发送给对应的hart

如果RISC-V hart实现了特权架构的虚拟机监控器扩展，IMSIs可能会有额外的“guest interrupt files”用于将中断传递给虚拟机
如果系统中还包含了一个IOMMU（Input-Output Memory Management Units）来执行I/O设备的内存访问的地址转换，那么来自I/O设备的MSI还需要进行处理。

![image-20241118104335845](https://raw.githubusercontent.com/upsetgrass/typora_pic_bed/main/image-20241118104335845.png)

### 其他中断

定时器中断是完全支持的，软件中断部分支持（具体在第七章）

AIA为hart提供了大量对本地中断的支持，本地中断是指hart在响应**异步事件**（通常是错误）时，会“自我中断”，并且本地中断在hart内部，所以和定时器（一种本地中断）、软件中断相同，都不需要APLIC、IMSIC

ps：为什么软件中断不需要？软件中断是由操作系统或者应用程序的软件指令发出的，是直接在hart内部生成的中断信号，这些中断信号是硬编码在hart内部的

ps：定时器中断 - 是由hart内部的定时器模块发出，中断信号从hart内部生成和处理，不需要额外的中断路由，是处理器内部的固定功能模块之一，其操作和触发完全依赖于hart内部的计时机制。

## hart的中断标识

RISC-V特权架构为每一个hart的中断原因分配了一个独特的主身份码，该身份码是在中断发生时写入到CSR（控制和状态寄存器）中mcause（机器模式）和scause（监管模式）寄存器中的异常代码，用于帮助区分不同类型的中断。

0-15范围：特权架构规定的中断原因（定时器中断、软件中断、外部中断...）被分配到这个范围内

16号及更高位：由平台标准或自定义用途使用。

对于AIA高级中断架构中，16-23和32-47范围都由AIA控制，用于进一步定义平台或系统的标准中断类型，对于24-31，48号以上，这部分任然作为自定义使用，可以根据系统特有的中断原因，或根据需求构建新的中断类型。

![image-20241118115006745](https://raw.githubusercontent.com/upsetgrass/typora_pic_bed/main/image-20241118115006745.png)

对于外部中断具有不同的主身份码和次身份码，用于区分中断的种类和来源

1、主身份码是由特权级别决定：机器模式（Machine Level）：主身份码为11，监督模式（Supervisor Level）：主身份码为9，虚拟机监控器模式（VS-level）：主身份码是10，用于区分不同特权级别的外部中断

2、次身份码用于区分同一特权级下的不同中断原因或来源，并且并不只是外部中断会有次身份码

## 中断接收选择

对于RISC-V的AIA，是不支持直接的**广播**或**多播**机制，每个中断都明确地定位到单个hart和特权级别，这是由软件配置和控制的，不支持硬件级别的中断广播或多播，本地中断通常是由hart内部的事件触发，其他的hart无法看到；虚拟中断中软件可以将中断注入到低特权级别的虚拟机中，该中断只会影响注入的特定的虚拟机，不会影响其他的虚拟机或hart；定时器中断是RISC-V架构中唯一与特定核心绑定的中断；外部中断也只会通过APLIC或IMSIC路由管理传递给指定的hart；处理器间中断（InterProcessor Interrupt，IPI）为了向多个hart发送中断，发起中断的hart需要执行一个循环，逐一的向每个目标hart发送中断请求。

ps：广播 - 信息从一个源发送到网络中的**所有目标**，每个设备都会接收到广播信息（无线电广播，电视，收音机），多播 -  信息从一个源发送到一组特定的目标

RISC-V AIA不提供硬件机制来支持IPI的多播有以下原因 1）发送中断的花销远小于目标hart接收中断的花销 2）硬件实现的收益有限 3）大规模系统中hart过多，明确多播目标hart会增加系统复杂度

对于IO设备的单个中断需要通信到多个harts的情况下（情况非常少见），需要先将中断发送到单个hart中，然后通过IPI向其他harts发送信号。

“1-of-N机制”

## ISA扩展Smaia和Ssaia

AIA为RISC-V指令集体系结构ISA的扩展了Smaia和Ssaia，也就是Smaia和Ssaia是RISC-V AIA的具体实现形式，根据不同的系统需求来实现，对于Smaia是针对机器级别的执行环境，增加了一些控制状态寄存器（CSRs），用于记录中断状态、配置中断行为、处理中断优先逻辑等，AIA修改了hart对中断的响应行为，涵盖了所有特权级别的中断管理能力，全面支持了hart在M、S、U模式下的中断管理，Ssaia适用于监督级别（操作系统）的执行环境，为S模式提供与中断相关的扩展功能，帮助操作系统管理中断。

Smaia和Ssaia扩展仅涵盖对RISC-V指令集架构有影响的中断特性，他们定义的是hart内部与中断相关的行为，这些功能直接影响ISA（CSR、异常响应），而对于APLIC、IOMMU是非ISA功能





# CSRs

对于每个特权级下的处理单元（hart）可以捕获中断陷阱（interrupt traps）的情况，高级中断架构（Advanced Interrupt Architecture, AIA）增加了一些用于中断控制和处理的控制与状态寄存器（CSRs）。这些寄存器帮助在不同的特权级上管理中断的优先级、处理流程和相关的状态信息。



## Machine-level CSRs

对于mie、mip、mideleg寄存器的宽度扩展到了64位，以支持64种中断源



对于RV32（32位），表中列出的“高半部分CSR”提供了对寄存器高32位的访问，AIA要求RV32必须存在这些高半部分CSR，即使他们这些位可能全是只读的0，也就是说对于RV32，一个64bit的寄存器需要用RV32两个位宽的空间进行存储，对于低32位部分，存储在原始的CSR中，对于高32位部分会使用另外一个地址进行存储，所以如果硬件实现中没有用到高32位的中断源，此时只读高32位就是全0了，比如下图中的0x304和0x314

miselect和mireg提供了一个窗口，用于访问下表中列出的CSR之外的多个寄存器，miselect是一个索引寄存器，可写且读取合法值（WARL- Write Any Read Legal）的寄存器，其值决定了别名CSR mireg当前映射到哪个具体的寄存器，对于无IMSIC，miselect至少支持0\~0x3F的值（6位）；对于有IMSIC，miselect必须支持范围为0\~xFF（8位）

ps:miselect和mireg的意义：使用一个通用的CSR mireg，通过修改miselect的值来访问多个寄存器，而不需要为每个寄存器单独定义CSR地址

ps:WARL - Write Any（任意写入）Read Legal（读取合法值），允许向寄存器中写入任意值，读取时只返回硬件支持的合法值（mireg动态寄存器的访问范围）

0x3F - 3*$16^1$+15 = 63 - 0011 1111 - 6位

0xFF - 1111 1111 = 255 - 8位

miselect的值分配：

0x00–0x2F reserved  - 保留位是为了将来扩展或升级中断控制功能所进行保留的

0x30–0x3F major interrupt priorities - 定义了各个中断的优先级，从而决定中断的响应顺序

0x40–0x6F reserved  

0x70–0xFF external interrupts (only with an IMSIC) 外部中断



现在没有为0x00\~0xFF之外的地址分配标准寄存器，但miselect也可能会支持



![image-20241202100057636](https://raw.githubusercontent.com/upsetgrass/typora_pic_bed/main/image-20241202100057636.png)

如果miselect的最高位为1，这些值被预留用于自定义用途，可以通过mireg寄存器访问自定义寄存器，例如，如果`miselect`是一个值，其最高位设置为1，则它可以访问一些特殊寄存器，具体寄存器的定义可以在硬件实现中自定义，并且miselect的最高位随着XLEN变化而发生变化（X-架构的位数，LEN长度），这个特性不一定严格执行

如果miselect的值位于保留的范围或者超过0xFF，但未指定自定义用途的数值，那么访问mireg时会引发非法指令异常；对于没有实现IMSIC，访问0x70-0xFF时也会引发非法指令异常

ps：miselect的最高位是标记位（标准寄存器还是自定义寄存器），其他位是数据位，数据位就用于决定mireg访问的是哪个寄存器

ps：mireg是一个别名寄存器，本身不代表一个固定的寄存器，根据索引寄存器miselect选择不同的寄存机来访问，可以访问多个寄存器。

mtopei寄存器：只有在实现了IMSIC时才存在，用于报告最高优先级的中断（具体在IMSIC章节中说明）

如果实现了S模式，mvien和mvip寄存器则支持用于S模式的中断过滤和虚拟中断功能（后续会讲）

ps：MRW - 机器模式下的读写  MRO - 机器模式下的只读



如果实现了**Smcsrind**扩展（给S模式下为中断控制器提供额外的寄存器，用于控制过滤S模型下的中断，mireg2-mireg6就是用于访问smcsrind扩展中定义的额外寄存器），那么当`miselect`的值处于`0x30–0x3F`或`0x70–0xFF`范围时，访问别名寄存器`mireg2`到`mireg6`会引发**非法指令异常**。



## Supervisor-level CSRs

## Hypervisor and VS CSRs

## Virtual instruction exceptions

## Access control by the state-enable CSRs



# Incoming MSI Controller（IMSIC）

IMSIC (**Incoming MSI Controller**)，即“消息信号中断控制器”，是 RISC-V 架构中的一个**可选硬件组件**，用于处理 **MSI（Message-Signaled Interrupts，消息信号中断）**，每个hart都有一个独立的IMSIC，用于接收来自外部设备的MSI，并记录其相关信息，当有挂起且被启用的中断时，会让对应的hart进行处理。

IMSIC 的主要功能

1、接收中断：IMSIC 提供了若干**内存映射寄存器**（Memory-Mapped Registers），位于机器的地址空间中，用于接收外设发送的 MSI。

外设通过这些寄存器向 IMSIC 发送中断请求。

2、记录中断：IMSIC 会在其内部记录哪些中断请求处于**挂起状态**。

3、通知 hart：如果中断已被启用（enabled），IMSIC 会将其标记为“可服务”（pending），并通过 hart 的中断处理逻辑触发相应的响应。



1、通过内存映射寄存器（Memory-Mapped Registers），IMSIC 在机器地址空间中占据特定范围的地址，这些地址对应的寄存器用于接收 MSI，外设通过写入这些寄存器，向 IMSIC 发送中断。

2、通过RISC-V的控制和状态寄存器（CSRs），除了内存映射寄存器，IMSIC 还通过一系列与 hart 关联的CSR与软件交互，这些 CSR 用于：控制 IMSIC 的行为（如启用或禁用某些中断）；检查中断的状态（如挂起中断的优先级）。

## 中断文件和中断标识符

在RISC-V系统中，MSI指向特定的hart，和特定hart的特定权限级别，当一个特定的MSI中断被触发，IMSIC会根据设置的目标特权级决定将中断传递给hart的哪个特权级别。机器模式的中断传递给机器模式；如果系统视线了Hypervisor扩展，IMSIC可能运行MSI中断定向到特定的虚拟hart，根据虚拟化层的特权级别（例如VS-virtual supervisor虚拟超级用户级  VM-virtuall Machine）来处理中断。

对于hart每个特权等级都会实现一个中断文件，用于独立管理各自特权级别的中断信息，确保在不同的特权级别之间中断处理隔离，如果实现了虚拟化扩展，那么每个虚拟hart都有独立的来宾中断文件，数量与GEILEN（Guest External Interrupts Length）相同，允许对虚拟机中的中断进行处理。

ps：中断文件-IMSIC只负责中断信号的接收和初步处理，它并不处理如何将中断映射到具体的特权级别和虚拟hart，所以尽管IMSIC提供了接受中断的功能，但仍然需要为每个hart的特权级配置单独的中断文件，可以理解为：IMSIC是处理中断的“入口”，而中断文件负责具体的中断控制、优先级判断、中断过滤等策略、工作。



中断文件的结构：

每个中断文件由两组大小相同的位 数组组成：1、中断挂起位：用于记录已经达到但尚未处理的MSI，这些位表示特定的中断是否已到达，但处理尚未完成。每个位置对应一个特定的中断2、中断使能位：用于指定该hart当前是否接受特定的中断，即哪些中断是可以被处理的，哪一些是被屏蔽的。

如果某个MSI到达IMSIC，并且对应的挂起位被设置为1，则表示该MSI尚未被处理，如果对应的使能位被设置为1，那么该MSI被允许被处理。

中断文件中的每一个位置，对应于一个不同的中断身份编号。该编号用于区分不同来源的MSI，可能是不同的硬件设备、外部事件，每个中断文件都有一个唯一的表示。

IMSIC会为每个外部中断分配一个独特的中断身份编号，这些编号称为中断文件中的外部中断的次要身份，次要身份是同一中断源下不同事件或子类型

ps：这里的次要身份、主要身份，主要身份是用于区分中断的优先级或来源类别，而次要身份专注于具体的事件管理。每个位数组都包含了不同来源的所有细分中断类型，所以可以仅通过次要身份就确定具体中断类型。



中断标识 - 用于标识不同中断的来源或中断类型的编号，是从1-N的连续编号
中断身份数 - 指的是中断文件中支持的中断标识的数量，既可以管理多少种不同的中断身份。



每个中断文件内的中断身份标识符与其他中断文件中的标识符没有关系，因此不同中断文件的身份标识并不统一，因此在不同中断文件中对于不同的中断类型可以使用相同的标识符，所以如果考虑一个系统中中断源总数可能是：单中断文件中中断身份数 * 中断文件总数，例如一个中断文件有64个标识符，系统中有10个中断文件（hart个数，hart支持的特权个数，每个hart支持的虚拟hart个数），那么可以支持最多640个独立的中断源



不是所有的中断文件在系统中都有相同的大小。对于给定的hart，来宾中断guest external interrupts的中断文件需要具有相同的大小；对于机器级和监督级的中断文件大小可以不同于来宾中断，彼此也可以不同，不同hart之间的中断文件也可以不同。



平台可以为软件提供方法来配置IMSIC中中断文件的数量和大小（一般建议仅赋予hart的机器级有权限改变中断文件的数量和大小）



## MSI编码

单个信息信号中断MSI通常采用设备进行的自然对齐的32位写操作，地址和值由软件在设备（设备控制器）中配置，根据设备或控制器符合的标准版本中，地址可能会限制在低4GiB（32位）范围内，并且写入的数据可能是在16位范围内，其中高16位总是为0





## 中断优先级

