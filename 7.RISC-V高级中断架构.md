# 介绍

该文件对RISC-V高级中断架构进行了规定：
对《RISC-V指令集手册》第二卷规定的标准RISC-V hart（核心）特权架构进行了扩展，使得在现有的特权层级上支持更灵活的中断机制

ps：hart（Hardware Thread） - 硬件线程，表示一个可以独立执行指令流的处理单元，每个hart可以视为一个独立的CPU核心或线程，可以执行自己的指令、管理自己的寄存器，独立的处理中断和进行上下文切换（单核处理器一般只有一个hart）

AIA中定义了两个标准中断控制器，用于不同规模和需求的RISC-V系统 1）高级平台级中断控制器（APLIC）：用于更大或更复杂的系统，可以处理更复杂的中断需求    2）信息信号型中断控制器（IMSIC）：用于接收和处理信息信号中断（MSI）的控制器，适合分布式或虚拟化的系统架构。

AIA对与中断相关的其他系统组件提出了要求，以确保整个系统能有效的处理中断。包括如何管理中断信号、如何支持**虚拟化中断**。



RISC-V系统中，系统架构中断信号的设计与采用的中断类型，即信息传递中断（MSI，Message-Signaled Interrupts）还是传统的有线中断（wired interrupts）

**支持消息传递中断的系统**：对于完全支持MSI的系统中，每个处理核心（hart）都会配备一个**入站 MSI 控制器（IMSIC，Incoming MSI Controller）**，用来作为该核心的专用中断控制器，专门处理来自外部的中断信号。IMSIC 让每个核心可以直接接收 MSI 中断请求，适用于较大的系统，特别是那些带有 PCI 设备的系统，通过提供核心IMSICs（多个核心的中断控制器），有望完全支持MSIs（多个信息传递中断），对于较小的系统，继续使用有线中断和没有IMSICs的简单核心。

ps：PCI - 用于连接计算机主板和各种外设设备（显卡、网卡和存储设备）的高速接口标准，是一种标准化、快速的数据传输方式。

ps：IMSICs - 是为了多核处理器设计的，以便每个hart可以独立处理中断信号，提高并行处理能力和系统响应效率。

ps：外部中断 - 指的是有处理器以外的硬件设备产生的中断信号，对于软件发出的中断信号属于软件中断/内部中断，比如操作系统的系统调用等

**基于传统有线中断的系统**：在这种系统中，核心没有 IMSIC 控制器。系统中断信号通过有线连接方式传递。通常，小型系统的设计更适合这种方法，因为它简化了硬件设计，适合不需要 MSI 支持的简单核心。



## 没有IMSICs的外部中断

当RISC-V的核心没有IMSIC，外部中断通过专用线路发送给核心（hart），核心中的APLIC充当传统的**中心化中断控制器**，用于路由和优先级排序来自不同外部设备的中断信号，将中断信号路由到每个处理核心的适当级别（M级、S级、U级）

在没有IMSIC的情况下，就算RISC-V实现了**特权架构**中的hypervisor extension（**虚拟机监控器扩展**），当前的AIA也不支持外部中断直接传递给**虚拟机**，需要通过hypervisor（**虚拟机监控器**），由虚拟机监控器选择是否将中断转换为虚拟中断，并将其注入到虚拟机中。

ps：虚拟机监控器（Hypervisor）运行在物理硬件或操作系统上的软件层，负责创建和管理虚拟机。

ps：虚拟机监控器扩展（hypervisor extension）是RISC-V特权架构中引入的一种扩展，旨在支持虚拟化，允许一个虚拟机监控器能够管理多个虚拟机

ps：虚拟机（Virtual Machine，VM）虚拟机是由虚拟监控器创建的一个逻辑计算环境，可以运行自己的操作系统和应用程序



下图是有线中断的流程，有线中断发送中断信号给APLIC，APLIC负责中断挂起和中断使能，来记录当前待处理和中断是否被允许触发，允许触发后将中断信号按照优先级、路由选择等方式选择M还是S级的中断发送给核心。

![image-20241115155048502](https://raw.githubusercontent.com/upsetgrass/typora_pic_bed/main/image-20241115155048502.png)

## 有IMSICs的外部中断

为了能够接收MSI信号，RISC-V核心就需要有一个IMSIC，IMSIC是RISC-V hart的专用组件，每个IMSIC在系统的



